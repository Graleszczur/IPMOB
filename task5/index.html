<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Task 5</title>
    <link rel="stylesheet" href="index.css">
</head>
<body onload="initDatabase()">

<div class="form-style-6">
    <form id="addForm">
        <p>Dodaj klienta</p>
        <div>
            <label for="nameInput">Imię</label>
            <input type="text" id="nameInput">
        </div>
        <div>
            <label for="surnameInput">Nazwisko</label>
            <input type="text" id="surnameInput">
        </div>
        <div>
            <label for="phoneNumberInput">Numer telefonu</label>
            <input type="text" id="phoneNumberInput">
        </div>
        <button id="addButton">Dodaj</button>
    </form>
</div>

<div class="form-style-6">
    <form id="deleteForm">
        <p>Usuń klienta</p>
        <label for="idForDeletion">ID klienta</label>
        <input type="text" id="idForDeletion">
        <button id="deleteButton">Usuń</button>
    </form>
</div>

<table id="customers-table" class="styled-table">
    <thead>
    <tr>
        <th>ID</th>
        <th>Imię</th>
        <th>Nazwisko</th>
        <th>Numer telefonu</th>
    </tr>
    </thead>
    <tbody id="customers-table-body">
    </tbody>
</table>
<script>
    // In the following line, you should include the prefixes of implementations you want to test.
    window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
    // DON'T use "var indexedDB = ..." if you're not in a function.
    // Moreover, you may need references to some window.IDB* objects:
    window.IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.msIDBTransaction || {READ_WRITE: "readwrite"}; // This line should only be needed if it is needed to support the object's constants for older browsers
    window.IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange;
    // (Mozilla has never prefixed these objects, so we don't need window.mozIDB*)
    if (!window.indexedDB) {
        console.log("Your browser doesn't support a stable version of IndexedDB. Such and such feature will not be available.");
    }

    function initDatabase() {

        const request = window.indexedDB.open("MyTestDatabase", 3);
        request.onerror = function (event) {
            console.log("Error occurred during database setup");
        };
        request.onsuccess = function (event) {
            db = event.target.result;
            db.onerror = function (event) {
                console.log("Error has occurred: " + event.target.errorCode);
            };
            updateTableBody();
        };
        request.onupgradeneeded = function (event) {
            const db = event.target.result;
            const objectStore = db.createObjectStore("customers", {keyPath: "id", autoIncrement: true});
            objectStore.createIndex("name", "name", {unique: false});
            objectStore.createIndex("surname", "surname", {unique: false});
            objectStore.createIndex("phoneNumber", "phoneNumber", {unique: true});
            objectStore.transaction.oncomplete = function (event) {
            };
        };
    }

    function updateTableBody() {
        document.getElementById("customers-table-body").innerHTML = "";
        const request = db.transaction("customers").objectStore("customers").openCursor();
        request.onerror = function (event) {
            console.log(event);
        };
        request.onsuccess = function (event) {
            const cursor = event.target.result;
            if (cursor) {
                document.getElementById("customers-table-body").innerHTML += "<tr><td>" + cursor.key + "</td><td>"
                    + cursor.value.name + "</td><td>"
                    + cursor.value.surname + "</td><td>"
                    + cursor.value.phoneNumber + "</td></tr>";
                cursor.continue();
            }
        };
    }

    document.getElementById('addButton').onclick = function (e) {
        const name = document.getElementById('nameInput').value;
        const surname = document.getElementById('surnameInput').value;
        const phoneNumber = document.getElementById('phoneNumberInput').value;

        const customerEntry = {
            name: name,
            surname: surname,
            phoneNumber: phoneNumber
        }

        let transaction = db.transaction(["customers"], "readwrite");
        transaction.oncomplete = function (event) {
            console.log("Transaction successful");
        };
        transaction.onerror = function (event) {
            console.log("Error during transaction");
        };
        const customersObjectStore = transaction.objectStore("customers");
        const request = customersObjectStore.add(customerEntry);
        request.onsuccess = function (event) {
            console.log("Customer entry added to database!");
        };
        updateTableBody();
    }

    document.getElementById('deleteButton').onclick = function (e) {
        const idToDelete = document.getElementById('idForDeletion').value;
        const request = db.transaction(["customers"], "readwrite").objectStore("customers").delete(parseInt(idToDelete));
        request.onsuccess = function (event) {
            console.log("Customer deleted");
        }
        updateTableBody();
    }
</script>
</body>
</html>